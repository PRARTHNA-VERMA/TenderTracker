
@{
    ViewData["Title"] = "Dashboard";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor Accessor

@model IEnumerable<TenderTracker.Models.TenderModel>

@if (TempData["SuccessMessage"] != null)
{
    <script>
        alert('@TempData["SuccessMessage"]');
    </script>
}
@if (TempData["Success"] != null)
{
    <script>
        alert('@TempData["Success"]');
    </script>
}
@if (TempData["ErrorMessage"] != null)
{
    <script>
        alert('@TempData["ErrorMessage"]');
    </script>
}

<div class="content-wrapper">
    <section>
        <div>
            @{
                var user_type = Accessor.HttpContext.Session.GetString("user_type");
                var Name = Accessor.HttpContext.Session.GetString("Name");
            }
        </div>
        <div class="container-fluid">
            <div class="row m-3">
                <h3 class="col-md-8">All Tenders List</h3>
            </div>

            <div class="card">
                <div class="card-body">
                   

                    <table id="example" class="table table-responsive table-bordered table-striped table-hover" style="display:block;">
                        <thead>
                            <tr>
                                <th class="bg-primary text-light">S.NO.</th>
                                <th class="bg-primary text-light">Empanelment Type</th>
                                <th class="bg-primary text-light">Tender No.</th>
                                <th class="bg-primary text-light">Department</th>
                                <th class="bg-primary text-light">State</th>
                                <th class="bg-primary text-light">City</th>
                                <th class="bg-primary text-light">Tender Due Date</th>
                                <th class="bg-primary text-light">Assigned To</th>
                                <th class="bg-primary text-light">Submitted Date</th>
                                @if (user_type != "3")
                                {
                                    <th class="bg-primary text-light">Action</th>
                                }
                            </tr>
                        </thead>
                        <tbody id="tenderTableBody">
                            @{
                                int i = 0;
                                foreach (var item in Model)
                                {
                                    i++;
                                    var remarkStatus = item.rowData.tender_remark; // Get remark_status value
                                    <tr data-remark-status="@remarkStatus">
                                        <td>@i</td>
                                        <td>@item.rowData.Empanelment_type</td>
                                        <td>@item.rowData.Tender</td>
                                        <td>@item.rowData.Department</td>
                                        <td>@item.rowData.State</td>
                                        <td>@item.rowData.City</td>
                                        <td>@item.rowData.Tender_due_date</td>
                                        <td>
                                            @(string.IsNullOrEmpty(item.rowData.Name) ? "N/A" : item.rowData.Name)
                                        </td>
                                        <td>@(Convert.ToDateTime(item.rowData.created_date).ToString("dd-MM-yyyy"))</td>
                                        @if (user_type != "3")
                                        {
                                            <td>
                                                @{
                                                    var linkColor = string.IsNullOrEmpty(item.rowData.tender_remark) ? "btn-primary" : "btn-success";
                                                }
                                                <a asp-action="ViewTender" asp-controller="Dashboard" asp-route-id="@item.rowData.id" class="btn @linkColor">View</a>
                                            </td>
                                        }
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- ✅ DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.1.0/css/buttons.dataTables.min.css">

<!-- ✅ jQuery (Required for DataTables) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- ✅ DataTables JavaScript -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.1.0/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.1.0/js/buttons.html5.min.js"></script>





<!-- ✅ DataTables Initialization with Pagination -->
<script>
    $(document).ready(function () {
        var table = $('#example').DataTable({
            paging: true,          // Enable pagination
            lengthMenu: [5, 10, 25, 50], // Rows per page options
            pageLength: 10,        // Default number of rows per page
            searching: true,       // Enable search functionality
            ordering: true,        // Enable sorting
            info: true,            // Show table info
            responsive: true,      // Make the table responsive
            language: {
                "paginate": {
                    "first": "First",
                    "last": "Last",
                    "next": "Next",
                    "previous": "Prev"
                }
            },
            dom: '<"d-flex justify-content-between"fB>rt<"d-flex justify-content-between"lp i>',
            buttons: [
                {
                    extend: 'csvHtml5',
                    text: 'Export',
                    className: 'btn btn-success'
                }
            ]
        });

        // ✅ Ensure Export Button Works
        $('#exportButton').on('click', function () {
            table.button('.buttons-csv').trigger();
        });

        // ✅ Row Color Based on Remark Status
        $("#tenderTableBody tr").each(function () {
            var remarkStatus = $(this).attr("data-remark-status");
            if (remarkStatus && remarkStatus !== "N/A") {
                $(this).css("background-color", "red").css("color", "white");
            } else {
                $(this).css("background-color", "gray").css("color", "white");
            }
        });
    });
</script>
